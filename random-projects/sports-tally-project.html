<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Tally App</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for highlighted picks */
        .pick-selected {
            border: 2px solid #22c55e; /* green-500 */
            box-shadow: 0 0 10px #22c55e;
        }
        .pick-correct {
            background-color: #166534; /* green-800 */
            border: 1px solid #22c55e;
        }
        .pick-incorrect {
            background-color: #991b1b; /* red-800 */
            border: 1px solid #ef4444;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-4">Sports Tally</h1>
            <!-- 2. Role Selector -->
            <div id="role-selector" class="flex justify-center gap-4 p-4 bg-gray-800 rounded-lg">
                <button onclick="handleAdminLogin()" class="role-btn px-6 py-3 font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition duration-200">
                    Admin
                </button>
                <button onclick="handleRoleSelect('Brian F')" class="role-btn px-6 py-3 font-semibold rounded-lg bg-blue-600 hover:bg-blue-700 transition duration-200">
                    Brian F
                </button>
                <button onclick="handleRoleSelect('Michael R')" class="role-btn px-6 py-3 font-semibold rounded-lg bg-green-600 hover:bg-green-700 transition duration-200">
                    Michael R
                </button>
            </div>
        </header>

        <!-- 3. Loading/Message Area -->
        <div id="message-area" class="text-center text-lg text-gray-400">
            Please select your role to begin.
        </div>

        <!-- 4. Main App Container (hidden by default) -->
        <div id="app-container" class="hidden">
            
            <!-- 4a. Admin Panel (hidden by default) -->
            <div id="admin-panel" class="hidden bg-gray-800 p-6 rounded-lg shadow-xl mb-8">
                <h2 class="text-2xl font-bold mb-4">Admin Panel</h2>
                <form id="add-game-form" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label for="game-week" class="block text-sm font-medium text-gray-300 mb-1">Week</label>
                        <input type="number" id="game-week" min="1" value="1" class="w-full bg-gray-700 text-white p-2 rounded-lg border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="game-date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="game-date" class="w-full bg-gray-700 text-white p-2 rounded-lg border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="team-a" class="block text-sm font-medium text-gray-300 mb-1">Team A</label>
                        <input type="text" id="team-a" placeholder="e.g., Eagles" class="w-full bg-gray-700 text-white p-2 rounded-lg border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="team-b" class="block text-sm font-medium text-gray-300 mb-1">Team B</label>
                        <input type="text" id="team-b" placeholder="e.g., Cowboys" class="w-full bg-gray-700 text-white p-2 rounded-lg border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="self-end">
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Add Game
                        </button>
                    </div>
                </form>
            </div>

            <!-- 4b. Main Content Area (Games & Scoreboard) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Games List (Main Column) -->
                <div class="lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold">Games</h2>
                        <div>
                            <label for="week-filter" class="text-sm font-medium text-gray-300 mr-2">Filter by Week:</label>
                            <select id="week-filter" class="bg-gray-700 text-white p-2 rounded-lg border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                    </div>
                    <div id="game-list" class="space-y-6">
                        <!-- Game cards will be populated here -->
                    </div>
                </div>

                <!-- Scoreboard (Sidebar) -->
                <div class="lg:col-span-1">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl sticky top-8">
                        <h2 class="text-3xl font-bold mb-6">Scoreboard</h2>
                        <div id="scoreboard" class="space-y-4">
                            <!-- Scores will be populated here -->
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- 5. Firebase and App Logic -->
    <script type="module">
        // 5a. Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDocs, 
            setDoc, 
            addDoc,
            updateDoc,
            onSnapshot, 
            collection, 
            query, 
            where,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES ---
        let db, auth, userId;
        let currentUserRole = null; // 'Admin', 'Brian F', 'Michael R'
        let currentWeek = 1;
        let allGames = []; // Local cache of games
        let allPicks = []; // Local cache of picks
        let allScores = {}; // Local cache of scores
        let maxWeek = 1; // To populate week filter

        // Firestore collection paths
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sports-tally-default';
        const gamesCollectionPath = `/artifacts/${appId}/public/data/sports_tally_games`;
        const picksCollectionPath = `/artifacts/${appId}/public/data/sports_tally_picks`;
        const scoresCollectionPath = `/artifacts/${appId}/public/data/sports_tally_scores`;

        // --- DOM ELEMENTS ---
        const roleSelector = document.getElementById('role-selector');
        const messageArea = document.getElementById('message-area');
        const appContainer = document.getElementById('app-container');
        const adminPanel = document.getElementById('admin-panel');
        const addGameForm = document.getElementById('add-game-form');
        const gameList = document.getElementById('game-list');
        const scoreboard = document.getElementById('scoreboard');
        const weekFilter = document.getElementById('week-filter');

        // --- INITIALIZATION ---
        
        async function initApp() {
            setLogLevel('Debug');
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated:", userId);
                        // Once authenticated, we can set up listeners
                        // We wait for role selection to show the app
                    } else {
                        // No user. Try token or anonymous
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                messageArea.textContent = "Error loading app. Please refresh.";
            }
        }
        
        // Call init on load
        initApp();

        // --- ROLE SELECTION ---
        
        window.handleAdminLogin = () => {
            const pass = prompt("Enter Admin Password:");
            if (pass === "nepobaby") {
                handleRoleSelect('Admin');
                messageArea.classList.add('hidden'); // Hide any previous error
            } else {
                // Can't use alert() per requirements
                messageArea.textContent = "Incorrect Admin Password.";
                messageArea.classList.remove('hidden');
                // The console.error line was here, now removed.
            }
        }

        window.handleRoleSelect = (role) => {
            currentUserRole = role;
            console.log("Role selected:", currentUserRole);

            // Style active role button
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-offset-2', 'ring-offset-gray-900');
                if (btn.textContent.trim() === role) {
                    if (role === 'Admin') btn.classList.add('ring-4', 'ring-offset-2', 'ring-offset-gray-900', 'ring-indigo-400');
                    if (role === 'Brian F') btn.classList.add('ring-4', 'ring-offset-2', 'ring-offset-gray-900', 'ring-blue-400');
                    if (role === 'Michael R') btn.classList.add('ring-4', 'ring-offset-2', 'ring-offset-gray-900', 'ring-green-400');
                }
            });

            // Show app, hide message
            messageArea.classList.add('hidden');
            appContainer.classList.remove('hidden');

            // Show admin panel if Admin
            if (currentUserRole === 'Admin') {
                adminPanel.classList.remove('hidden');
            } else {
                adminPanel.classList.add('hidden');
            }
            
            // Setup listeners if this is the first time selecting a role
            if (allGames.length === 0) {
                 setupListeners();
            }

            // Re-render the app for the new role
            renderApp();
        }

        // --- EVENT LISTENERS ---

        // Setup Firestore listeners
        function setupListeners() {
            if (!db) return;
            
            // 1. Games Listener
            const gamesQuery = query(collection(db, gamesCollectionPath));
            onSnapshot(gamesQuery, (snapshot) => {
                allGames = [];
                let newMaxWeek = 1;
                snapshot.forEach(doc => {
                    const game = { id: doc.id, ...doc.data() };
                    allGames.push(game);
                    if (game.week > newMaxWeek) {
                        newMaxWeek = game.week;
                    }
                });
                console.log("Games updated:", allGames);
                maxWeek = newMaxWeek;
                currentWeek = maxWeek; // Automatically set to latest week
                populateWeekFilter();
                renderApp();
            }, (error) => console.error("Error listening to games:", error));

            // 2. Picks Listener
            const picksQuery = query(collection(db, picksCollectionPath));
            onSnapshot(picksQuery, (snapshot) => {
                allPicks = [];
                snapshot.forEach(doc => {
                    allPicks.push({ id: doc.id, ...doc.data() });
                });
                console.log("Picks updated:", allPicks);
                renderApp();
            }, (error) => console.error("Error listening to picks:", error));

            // 3. Scores Listener
            const scoresQuery = query(collection(db, scoresCollectionPath));
            onSnapshot(scoresQuery, (snapshot) => {
                allScores = {};
                snapshot.forEach(doc => {
                    allScores[doc.id] = doc.data(); // doc.id is 'Brian F' or 'Michael R'
                });
                console.log("Scores updated:", allScores);
                renderScoreboard(); // Just re-render scoreboard
            }, (error) => console.error("Error listening to scores:", error));
        }

        // Week filter change
        weekFilter.addEventListener('change', (e) => {
            currentWeek = parseInt(e.target.value);
            renderApp();
        });

        // Admin: Add game form
        addGameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (currentUserRole !== 'Admin') return;

            const week = parseInt(document.getElementById('game-week').value);
            const gameDate = document.getElementById('game-date').value;
            const teamA = document.getElementById('team-a').value;
            const teamB = document.getElementById('team-b').value;

            if (!teamA || !teamB || !week || !gameDate) {
                // Using console.error instead of alert
                console.error("Please fill out all fields.");
                messageArea.textContent = "Please fill out all fields in the admin form.";
                messageArea.classList.remove('hidden');
                return;
            }

            try {
                await addDoc(collection(db, gamesCollectionPath), {
                    week: week,
                    gameDate: gameDate,
                    teamA: teamA,
                    teamB: teamB,
                    winner: null,
                    status: "upcoming" // 'upcoming' or 'final'
                });
                console.log("Game added!");
                // Clear form
                addGameForm.reset();
                document.getElementById('game-week').value = week; // Keep the week for multiple additions
            } catch (error) {
                console.error("Error adding game:", error);
            }
        });


        // --- ACTION HANDLERS (called from dynamic HTML) ---

        // User: Make a pick
        window.handlePick = async (gameId, week, pickedTeam) => {
            if (!currentUserRole || currentUserRole === 'Admin') return;
            
            // Doc ID is a composite of gameId and user role to ensure 1 pick per user per game
            const pickDocId = `${gameId}_${currentUserRole}`;
            
            try {
                await setDoc(doc(db, picksCollectionPath, pickDocId), {
                    gameId: gameId,
                    userId: currentUserRole,
                    week: week,
                    pickedTeam: pickedTeam
                });
                console.log("Pick saved:", currentUserRole, pickedTeam);
            } catch (error) {
                console.error("Error saving pick:", error);
            }
        }

        // Admin: Mark a winner
        window.handleMarkWinner = async (gameId, winningTeam) => {
            if (currentUserRole !== 'Admin') return;

            try {
                // 1. Update the game doc
                await updateDoc(doc(db, gamesCollectionPath, gameId), {
                    winner: winningTeam,
                    status: 'final'
                });
                console.log("Winner marked:", gameId, winningTeam);

                // 2. Trigger score recalculation
                // This is a critical step
                await recalculateAllScores();
                
            } catch (error) {
                console.error("Error marking winner:", error);
            }
        }

        // --- SCORE TALLYING LOGIC ---

        async function recalculateAllScores() {
            console.log("Recalculating all scores...");
            
            // We can use the local caches 'allGames' and 'allPicks'
            // but fetching fresh data is safer to avoid race conditions.
            // Let's use the local cache for now, as onSnapshot keeps it up to date.
            // The function is triggered *after* the update, but the listener
            // might not have fired yet. Let's fetch final games.
            
            const finalGamesQuery = query(collection(db, gamesCollectionPath), where("status", "==", "final"));
            const finalGamesSnapshot = await getDocs(finalGamesQuery);
            const finalGames = [];
            finalGamesSnapshot.forEach(doc => finalGames.push({id: doc.id, ...doc.data()}));

            const picksSnapshot = await getDocs(collection(db, picksCollectionPath));
            const allPicksData = [];
            picksSnapshot.forEach(doc => allPicksData.push(doc.data()));

            let brianScores = { totalScore: 0, weeklyScores: {} };
            let michaelScores = { totalScore: 0, weeklyScores: {} };

            // Loop through every single final game
            for (const game of finalGames) {
                const weekStr = `week${game.week}`;
                
                // Init weekly score if it doesn't exist
                if (!brianScores.weeklyScores[weekStr]) brianScores.weeklyScores[weekStr] = 0;
                if (!michaelScores.weeklyScores[weekStr]) michaelScores.weeklyScores[weekStr] = 0;
                
                // Find Brian's pick for this game
                const brianPick = allPicksData.find(p => p.gameId === game.id && p.userId === 'Brian F');
                if (brianPick && brianPick.pickedTeam === game.winner) {
                    brianScores.totalScore++;
                    brianScores.weeklyScores[weekStr]++;
                }

                // Find Michael's pick for this game
                const michaelPick = allPicksData.find(p => p.gameId === game.id && p.userId === 'Michael R');
                if (michaelPick && michaelPick.pickedTeam === game.winner) {
                    michaelScores.totalScore++;
                    michaelScores.weeklyScores[weekStr]++;
                }
            }
            
            console.log("New Scores:", { brianScores, michaelScores });

            // 3. Update scores in Firestore
            try {
                await setDoc(doc(db, scoresCollectionPath, 'Brian F'), {
                    userId: 'Brian F',
                    ...brianScores
                });
                await setDoc(doc(db, scoresCollectionPath, 'Michael R'), {
                    userId: 'Michael R',
                    ...michaelScores
                });
                console.log("Scoreboard updated in Firestore.");
            } catch (error) {
                console.error("Error updating scores:", error);
            }
        }


        // --- UI RENDERING ---

        function populateWeekFilter() {
            weekFilter.innerHTML = '';
            for (let i = 1; i <= maxWeek; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Week ${i}`;
                weekFilter.appendChild(option);
            }
            // Set selected to the current global week
            weekFilter.value = currentWeek;
        }

        // Main render function
        function renderApp() {
            if (!currentUserRole) return; // Don't render if no role is selected
            renderGameList();
            renderScoreboard();
        }

        // Render Game List
        function renderGameList() {
            gameList.innerHTML = ''; // Clear list
            
            const gamesForWeek = allGames.filter(g => g.week === currentWeek);

            if (gamesForWeek.length === 0) {
                gameList.innerHTML = `<div class="text-gray-400 text-center p-8">No games added for Week ${currentWeek} yet.</div>`;
                return;
            }

            for (const game of gamesForWeek) {
                // Find picks for this game
                const brianPick = allPicks.find(p => p.gameId === game.id && p.userId === 'Brian F');
                const michaelPick = allPicks.find(p => p.gameId === game.id && p.userId === 'Michael R');
                const userPick = (currentUserRole === 'Brian F') ? brianPick : michaelPick;

                // Format date
                let gameDateStr = '';
                if (game.gameDate) {
                    try {
                        const dateParts = game.gameDate.split('-'); // 'YYYY-MM-DD'
                        const gameDateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                        gameDateStr = gameDateObj.toLocaleDateString(undefined, { month: 'short', day: 'numeric', timeZone: 'UTC' });
                    } catch (e) {
                        console.warn("Could not parse date:", game.gameDate);
                    }
                }

                let gameCardHTML = `
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm font-semibold text-indigo-400">
                                WEEK ${game.week} ${gameDateStr ? `(${gameDateStr})` : ''}
                            </span>
                            <span class="text-sm font-semibold ${game.status === 'final' ? 'text-red-400' : 'text-green-400'}">
                                ${game.status.toUpperCase()}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                `;

                // --- Team A Button/Info ---
                let teamAClass = 'team-btn p-4 rounded-lg text-center transition duration-200';
                if (game.status === 'upcoming') {
                    teamAClass += ' bg-gray-700 hover:bg-gray-600 cursor-pointer';
                    if (userPick && userPick.pickedTeam === game.teamA) teamAClass += ' pick-selected';
                } else {
                    // Game is final
                    if (brianPick && brianPick.pickedTeam === game.teamA) teamAClass += (game.winner === game.teamA ? ' pick-correct' : ' pick-incorrect');
                    else if (michaelPick && michaelPick.pickedTeam === game.teamA) teamAClass += (game.winner === game.teamA ? ' pick-correct' : ' pick-incorrect');
                    else teamAClass += ' bg-gray-700'; // Not picked
                }
                
                gameCardHTML += `
                    <div 
                        class="${teamAClass}" 
                        ${game.status === 'upcoming' && currentUserRole !== 'Admin' ? `onclick="handlePick('${game.id}', ${game.week}, '${game.teamA}')"` : ''}
                    >
                        <span class="text-xl font-bold">${game.teamA}</span>
                        ${game.status === 'final' ? `
                            <div class="text-xs mt-1">
                                ${brianPick && brianPick.pickedTeam === game.teamA ? '<span class="text-blue-300">Brian</span>' : ''}
                                ${michaelPick && michaelPick.pickedTeam === game.teamA ? '<span class="text-green-300 ml-1">Michael</span>' : ''}
                            </div>
                        ` : ''}
                    </div>
                `;

                // --- Team B Button/Info ---
                let teamBClass = 'team-btn p-4 rounded-lg text-center transition duration-200';
                 if (game.status === 'upcoming') {
                    teamBClass += ' bg-gray-700 hover:bg-gray-600 cursor-pointer';
                    if (userPick && userPick.pickedTeam === game.teamB) teamBClass += ' pick-selected';
                } else {
                    // Game is final
                    if (brianPick && brianPick.pickedTeam === game.teamB) teamBClass += (game.winner === game.teamB ? ' pick-correct' : ' pick-incorrect');
                    else if (michaelPick && michaelPick.pickedTeam === game.teamB) teamBClass += (game.winner === game.teamB ? ' pick-correct' : ' pick-incorrect');
                    else teamBClass += ' bg-gray-700'; // Not picked
                }

                gameCardHTML += `
                    <div 
                        class="${teamBClass}" 
                        ${game.status === 'upcoming' && currentUserRole !== 'Admin' ? `onclick="handlePick('${game.id}', ${game.week}, '${game.teamB}')"` : ''}
                    >
                        <span class="text-xl font-bold">${game.teamB}</span>
                        ${game.status === 'final' ? `
                            <div class="text-xs mt-1">
                                ${brianPick && brianPick.pickedTeam === game.teamB ? '<span class="text-blue-300">Brian</span>' : ''}
                                ${michaelPick && michaelPick.pickedTeam === game.teamB ? '<span class="text-green-300 ml-1">Michael</span>' : ''}
                            </div>
                        ` : ''}
                    </div>
                `;

                gameCardHTML += `</div>`; // Close grid

                // --- Admin/Status Footer ---
                if (game.status === 'final') {
                    gameCardHTML += `
                        <div class="mt-4 text-center">
                            <span class="text-lg font-semibold">Winner: <span class="text-yellow-400">${game.winner}</span></span>
                        </div>
                    `;
                } else if (currentUserRole === 'Admin' && game.status === 'upcoming') {
                    gameCardHTML += `
                        <div class="mt-6 flex gap-4">
                            <button onclick="handleMarkWinner('${game.id}', '${game.teamA}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg text-sm">
                                Mark ${game.teamA} as Winner
                            </button>
                            <button onclick="handleMarkWinner('${game.id}', '${game.teamB}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg text-sm">
                                Mark ${game.teamB} as Winner
                            </button>
                        </div>
                    `;
                }

                gameCardHTML += `</div>`; // Close card
                gameList.innerHTML += gameCardHTML;
            }
        }
        
        // Render Scoreboard
        function renderScoreboard() {
            scoreboard.innerHTML = ''; // Clear scoreboard

            const brianData = allScores['Brian F'] || { totalScore: 0, weeklyScores: {} };
            const michaelData = allScores['Michael R'] || { totalScore: 0, weeklyScores: {} };

            scoreboard.innerHTML = `
                <!-- Brian F Score -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-2xl font-bold text-blue-300">Brian F</span>
                        <span class="text-3xl font-bold">${brianData.totalScore}</span>
                    </div>
                    <div class="text-sm text-gray-400 space-y-1">
                        ${Object.entries(brianData.weeklyScores).map(([week, score]) => `
                            <div>${week.replace('week', 'Week ')}: <span class="font-semibold text-gray-200">${score}</span></div>
                        `).join('')}
                    </div>
                </div>

                <!-- Michael R Score -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-2xl font-bold text-green-300">Michael R</span>
                        <span class="text-3xl font-bold">${michaelData.totalScore}</span>
                    </div>
                    <div class="text-sm text-gray-400 space-y-1">
                        ${Object.entries(michaelData.weeklyScores).map(([week, score]) => `
                            <div>${week.replace('week', 'Week ')}: <span class="font-semibold text-gray-200">${score}</span></div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

    </script>
</body>
</html>
